name: Train Models

on:
  # æ›œæ—¥ã”ã¨ã«ç•°ãªã‚‹ç«¶é¦¬å ´ã‚’å­¦ç¿’
  schedule:
    - cron: '0 21 * * 0'  # æ—¥æ›œ â†’ æœˆæ›œæœ6æ™‚(JST): å—é–¢æ±
    - cron: '0 21 * * 1'  # æœˆæ›œ â†’ ç«æ›œæœ6æ™‚(JST): åŒ—æ—¥æœ¬
    - cron: '0 21 * * 2'  # ç«æ›œ â†’ æ°´æ›œæœ6æ™‚(JST): ä¸­éƒ¨
    - cron: '0 21 * * 3'  # æ°´æ›œ â†’ æœ¨æ›œæœ6æ™‚(JST): è¥¿æ—¥æœ¬

  # æ‰‹å‹•å®Ÿè¡Œï¼ˆç«¶é¦¬å ´ã‚’1ã¤é¸æŠžï¼‰
  workflow_dispatch:
    inputs:
      track:
        description: 'å­¦ç¿’ã™ã‚‹ç«¶é¦¬å ´'
        required: true
        type: choice
        options:
          - å¤§äº•
          - å·å´Ž
          - èˆ¹æ©‹
          - æµ¦å’Œ
          - é–€åˆ¥
          - ç››å²¡
          - æ°´æ²¢
          - é‡‘æ²¢
          - ç¬ æ¾
          - åå¤å±‹
          - åœ’ç”°
          - å§«è·¯
          - é«˜çŸ¥
          - ä½è³€

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pandas numpy scikit-learn lightgbm beautifulsoup4 lxml requests

      - name: Determine tracks to train
        id: tracks
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹å‹•å®Ÿè¡Œ: é¸æŠžã•ã‚ŒãŸç«¶é¦¬å ´ã®ã¿
            echo "tracks=${{ github.event.inputs.track }}" >> $GITHUB_OUTPUT
          else
            # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ: æ›œæ—¥ã§åˆ†å²
            DAY_OF_WEEK=$(date -u +%u)
            case $DAY_OF_WEEK in
              1) echo "tracks=å¤§äº•,å·å´Ž,èˆ¹æ©‹,æµ¦å’Œ" >> $GITHUB_OUTPUT ;;  # æœˆæ›œ: å—é–¢æ±
              2) echo "tracks=é–€åˆ¥,ç››å²¡,æ°´æ²¢" >> $GITHUB_OUTPUT ;;       # ç«æ›œ: åŒ—æ—¥æœ¬
              3) echo "tracks=é‡‘æ²¢,ç¬ æ¾,åå¤å±‹" >> $GITHUB_OUTPUT ;;     # æ°´æ›œ: ä¸­éƒ¨
              4) echo "tracks=åœ’ç”°,å§«è·¯,é«˜çŸ¥,ä½è³€" >> $GITHUB_OUTPUT ;;  # æœ¨æ›œ: è¥¿æ—¥æœ¬
              *) echo "tracks=" >> $GITHUB_OUTPUT ;;
            esac
          fi

      - name: Train models
        if: steps.tracks.outputs.tracks != ''
        run: |
          echo "Training: ${{ steps.tracks.outputs.tracks }}"
          python train.py "${{ steps.tracks.outputs.tracks }}"

      - name: Commit and push
        if: steps.tracks.outputs.tracks != ''
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add models/*.pkl
          git diff --staged --quiet || git commit -m "ðŸ¤– ãƒ¢ãƒ‡ãƒ«æ›´æ–°: ${{ steps.tracks.outputs.tracks }} $(date +'%Y-%m-%d')"
          git push
