name: Train Models

on:
  # æ¯æ—¥1ç«¶é¦¬å ´ãšã¤å†å­¦ç¿’ï¼ˆ2é€±é–“ã§å…¨14å ´ï¼‰
  schedule:
    - cron: '0 21 * * 0'  # æ—¥æ›œ â†’ æœˆæ›œæœ6æ™‚(JST): å¤§äº•
    - cron: '0 21 * * 1'  # æœˆæ›œ â†’ ç«æ›œæœ6æ™‚(JST): å·å´
    - cron: '0 21 * * 2'  # ç«æ›œ â†’ æ°´æ›œæœ6æ™‚(JST): èˆ¹æ©‹
    - cron: '0 21 * * 3'  # æ°´æ›œ â†’ æœ¨æ›œæœ6æ™‚(JST): æµ¦å’Œ
    - cron: '0 21 * * 4'  # æœ¨æ›œ â†’ é‡‘æ›œæœ6æ™‚(JST): é–€åˆ¥
    - cron: '0 21 * * 5'  # é‡‘æ›œ â†’ åœŸæ›œæœ6æ™‚(JST): ç››å²¡
    - cron: '0 21 * * 6'  # åœŸæ›œ â†’ æ—¥æ›œæœ6æ™‚(JST): æ°´æ²¢

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      track:
        description: 'ç«¶é¦¬å ´'
        required: true
        type: choice
        options:
          - å¤§äº•
          - å·å´
          - èˆ¹æ©‹
          - æµ¦å’Œ
          - é–€åˆ¥
          - ç››å²¡
          - æ°´æ²¢
          - é‡‘æ²¢
          - ç¬ æ¾
          - åå¤å±‹
          - åœ’ç”°
          - å§«è·¯
          - é«˜çŸ¥
          - ä½è³€
      mode:
        description: 'ãƒ¢ãƒ¼ãƒ‰'
        required: true
        type: choice
        options:
          - init
          - update
        default: 'update'

permissions:
  contents: write

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 3å¹´åˆ†ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ï¼ˆ6æ™‚é–“ï¼‰

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pandas numpy scikit-learn lightgbm beautifulsoup4 lxml requests

      - name: Determine track and mode
        id: config
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹å‹•å®Ÿè¡Œ
            echo "track=${{ github.event.inputs.track }}" >> $GITHUB_OUTPUT
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          else
            # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ: æ›œæ—¥ã§ç«¶é¦¬å ´ã‚’æ±ºå®šï¼ˆå†å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼‰
            DAY_OF_WEEK=$(date -u +%u)
            case $DAY_OF_WEEK in
              1) TRACK="å¤§äº•" ;;
              2) TRACK="å·å´" ;;
              3) TRACK="èˆ¹æ©‹" ;;
              4) TRACK="æµ¦å’Œ" ;;
              5) TRACK="é–€åˆ¥" ;;
              6) TRACK="ç››å²¡" ;;
              7) TRACK="æ°´æ²¢" ;;
              *) TRACK="" ;;
            esac
            echo "track=$TRACK" >> $GITHUB_OUTPUT
            echo "mode=update" >> $GITHUB_OUTPUT
          fi

      - name: Train model
        if: steps.config.outputs.track != ''
        run: |
          echo "ğŸ‡ Training: ${{ steps.config.outputs.track }} (${{ steps.config.outputs.mode }})"
          python train.py "${{ steps.config.outputs.track }}" "${{ steps.config.outputs.mode }}"

      - name: Commit and push
        if: steps.config.outputs.track != ''
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add models/*.pkl models/*.json data/*.csv
          git diff --staged --quiet || git commit -m "ğŸ¤– ${{ steps.config.outputs.mode }}: ${{ steps.config.outputs.track }} $(date +'%Y-%m-%d')"
          # ãƒªãƒ¢ãƒ¼ãƒˆã®å¤‰æ›´ã‚’å–ã‚Šè¾¼ã‚“ã§ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆå›é¿ï¼‰
          git pull --rebase origin main || true
          git push
