name: Generate Daily Predictions

on:
  # æ¯æœ6æ™‚(JST)ã«è‡ªå‹•å®Ÿè¡Œ â†’ é–‹å‚¬ä¸­ã®å…¨ç«¶é¦¬å ´ã‚’è‡ªå‹•æ¤œå‡º
  schedule:
    - cron: '0 21 * * *'  # UTC 21:00 = JST 6:00

  # æ‰‹å‹•å®Ÿè¡Œï¼ˆç«¶é¦¬å ´ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œï¼‰
  workflow_dispatch:
    inputs:
      date:
        description: 'äºˆæ¸¬å¯¾è±¡æ—¥ (YYYY-MM-DDå½¢å¼ã€ç©ºæ¬„ã§ä»Šæ—¥)'
        required: false
        type: string
      track:
        description: 'ç«¶é¦¬å ´ï¼ˆç©ºæ¬„ã§å…¨ç«¶é¦¬å ´ã‚’è‡ªå‹•æ¤œå‡ºï¼‰'
        required: false
        type: choice
        default: ''
        options:
          - ''
          - å¤§äº•
          - å·å´
          - èˆ¹æ©‹
          - æµ¦å’Œ
          - é–€åˆ¥
          - ç››å²¡
          - æ°´æ²¢
          - é‡‘æ²¢
          - ç¬ æ¾
          - åå¤å±‹
          - åœ’ç”°
          - å§«è·¯
          - é«˜çŸ¥
          - ä½è³€

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pandas numpy scikit-learn lightgbm beautifulsoup4 lxml requests fastapi

      - name: Determine track code
        id: track
        run: |
          TRACK="${{ github.event.inputs.track }}"
          if [ -z "$TRACK" ]; then
            # ç©ºã®å ´åˆã¯å…¨ç«¶é¦¬å ´ã‚’è‡ªå‹•æ¤œå‡ºï¼ˆã‚³ãƒ¼ãƒ‰æŒ‡å®šãªã—ï¼‰
            echo "code=" >> $GITHUB_OUTPUT
            echo "name=å…¨ç«¶é¦¬å ´ï¼ˆè‡ªå‹•æ¤œå‡ºï¼‰" >> $GITHUB_OUTPUT
          else
            case "$TRACK" in
              "å¤§äº•") CODE="44" ;;
              "å·å´") CODE="45" ;;
              "èˆ¹æ©‹") CODE="43" ;;
              "æµ¦å’Œ") CODE="42" ;;
              "é–€åˆ¥") CODE="30" ;;
              "ç››å²¡") CODE="35" ;;
              "æ°´æ²¢") CODE="36" ;;
              "é‡‘æ²¢") CODE="46" ;;
              "ç¬ æ¾") CODE="47" ;;
              "åå¤å±‹") CODE="48" ;;
              "åœ’ç”°") CODE="50" ;;
              "å§«è·¯") CODE="51" ;;
              "é«˜çŸ¥") CODE="54" ;;
              "ä½è³€") CODE="55" ;;
            esac
            echo "code=$CODE" >> $GITHUB_OUTPUT
            echo "name=$TRACK" >> $GITHUB_OUTPUT
          fi

      - name: Generate predictions
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            DATE="${{ github.event.inputs.date }}"
          else
            DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          fi

          TRACK_CODE="${{ steps.track.outputs.code }}"
          if [ -z "$TRACK_CODE" ]; then
            echo "ğŸ”® äºˆæ¸¬ç”Ÿæˆ: $DATE - å…¨ç«¶é¦¬å ´ï¼ˆè‡ªå‹•æ¤œå‡ºï¼‰"
            python generate_predictions.py "$DATE"
          else
            echo "ğŸ”® äºˆæ¸¬ç”Ÿæˆ: $DATE - ${{ steps.track.outputs.name }}"
            python generate_predictions.py "$DATE" "$TRACK_CODE"
          fi

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add predictions/
          git diff --staged --quiet || git commit -m "ğŸ”® äºˆæ¸¬: ${{ steps.track.outputs.name }} $(TZ=Asia/Tokyo date +%Y-%m-%d)"
          git pull --rebase origin main || true
          git push
