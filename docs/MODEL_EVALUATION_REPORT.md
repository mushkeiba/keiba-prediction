# モデル評価レポート

**調査日**: 2025-12-30
**調査者**: Claude Code

---

## 概要

学習データの期間（6ヶ月〜36ヶ月）がモデル精度に与える影響を調査した。

---

## 調査方法

### バックテスト手法
```
1. CSVデータを時系列で分割
2. 古いデータで学習 → 新しいデータでテスト
3. 複数の学習期間を比較
```

### 評価指標
| 指標 | 説明 |
|------|------|
| 単勝的中率 | AI予測1位が実際に1着になった割合 |
| 複勝的中率 | AI予測1位が3着以内に入った割合 |
| AUC | 3着以内予測の精度（0.5=ランダム、1.0=完璧） |

### テスト条件
- テスト期間: 直近3ヶ月
- 学習期間: 6ヶ月 / 12ヶ月 / 18ヶ月 / 24ヶ月 / 30ヶ月 / 36ヶ月

---

## 調査結果

### 大井競馬場

**データ**: 41,237件 / 3,397レース（2022/12〜2025/12）

| 学習期間 | 単勝的中率 | 複勝的中率 | AUC |
|---------|-----------|-----------|------|
| 6ヶ月 | 23.6% | 51.7% | 0.692 |
| 12ヶ月 | 29.2% | 56.6% | 0.699 |
| 18ヶ月 | 30.2% | 58.0% | 0.700 |
| **24ヶ月** | **32.6%** | 57.3% | 0.704 |
| **30ヶ月** | 31.6% | **59.0%** | **0.706** |

**結論**: データが多いほど精度向上（30ヶ月が最良）

---

### 川崎競馬場

**データ**: 25,137件（2023/01〜2025/12）

| 学習期間 | 単勝的中率 | 複勝的中率 | AUC |
|---------|-----------|-----------|------|
| 6ヶ月 | 20.6% | 46.7% | 0.623 |
| **12ヶ月** | 20.6% | **48.3%** | 0.638 |
| **18ヶ月** | **22.2%** | 45.6% | **0.643** |
| 24ヶ月 | 23.3% | 45.0% | 0.642 |
| 30ヶ月 | 19.4% | 48.3% | 0.636 |

**結論**: 12〜18ヶ月がベスト（古すぎると逆効果）

---

## 競馬場間の比較

| 項目 | 大井 | 川崎 |
|------|------|------|
| 最適期間（複勝） | 30ヶ月 | 12ヶ月 |
| 最適期間（単勝） | 24ヶ月 | 24ヶ月 |
| 最適期間（AUC） | 30ヶ月 | 18ヶ月 |
| 最高複勝的中率 | **59.0%** | 48.3% |
| 最高AUC | **0.706** | 0.643 |

### 発見事項
1. **競馬場ごとに最適な学習期間が異なる**
2. **大井は「データ多いほど良い」傾向**
3. **川崎は「12〜18ヶ月がベスト」（古いデータは逆効果）**
4. **大井の方が全体的に予測精度が高い**

---

## 現在のシステム設定

```python
# train.py
INIT_DAYS = 1095  # 約3年（36ヶ月）
```

### 設定の妥当性
- 大井: 30ヶ月がベストだが、36ヶ月も悪くない
- 川崎: 12〜18ヶ月がベストなので、36ヶ月は長すぎる可能性

### 改善案
競馬場ごとに学習期間を最適化する：
```python
OPTIMAL_MONTHS = {
    "大井": 30,
    "川崎": 12,
    # 他の競馬場も要調査
}
```

---

## 評価スクリプトの使い方

```bash
# 単一競馬場の評価
python evaluate_model.py 大井
python evaluate_model.py 川崎

# 出力例
┌─────────┬──────────┬──────────┬──────────┐
│ 学習期間 │ 単勝的中 │ 複勝的中 │   AUC    │
├─────────┼──────────┼──────────┼──────────┤
│    6ヶ月 │   23.6% │   51.7%  │    0.692 │
│   12ヶ月 │   29.2% │   56.6%  │    0.699 │
...
```

---

## データの取得元

### CSVデータ
```
data/races_ohi.csv      # 大井競馬場
data/races_kawasaki.csv # 川崎競馬場
```

### データ取得方法
`train.py`がnetkeibaのレース結果ページをスクレイピング：
```
https://nar.netkeiba.com/race/result.html?race_id={race_id}
```

### 含まれるデータ
- `rank`: 着順（1着〜16着）← バックテストに使用
- `horse_win_rate`: 馬の勝率
- `jockey_win_rate`: 騎手の勝率
- `track_condition`: 馬場状態
- その他26カラム

---

## 今後の課題

1. **他の競馬場も評価する**（船橋、浦和、門別など）
2. **競馬場ごとの最適学習期間をシステムに反映**
3. **定期的なバックテストの自動化**
4. **回収率（ROI）も評価指標に追加**

---

## 関連ファイル

| ファイル | 説明 |
|---------|------|
| `evaluate_model.py` | バックテストスクリプト |
| `train.py` | モデル学習スクリプト |
| `data/races_*.csv` | レースデータ |
| `models/model_*.pkl` | 学習済みモデル |
