# CHANGELOG

## 2025-12-30
### 機能追加: 回収率計算スクリプト
**変更内容**:
- `calculate_roi.py` を新規作成
- 予測ログと実際の結果を照合して回収率を計算

**使い方**:
```bash
python calculate_roi.py 2025-12-30      # 指定日
python calculate_roi.py --all           # 全日分
```

**出力内容**:
- 単勝的中率・回収率
- 複勝的中率・回収率
- 妙味馬のみの成績
- 詳細レポート（JSON）

**出力例**:
```
【全予測】
  単勝: 5的中 / 12レース (41.7%) → 回収率 125%
  複勝: 8的中 / 12レース (66.7%) → 回収率 87%

【妙味馬のみ】
  単勝: 2的中 / 4レース (50.0%) → 回収率 180%
```

**保存先**: `roi_reports/{date}.json`

### 調査: 学習期間の最適化調査
**調査内容**:
- 学習データ期間（6ヶ月〜36ヶ月）がモデル精度に与える影響を調査
- 大井・川崎の2競馬場でバックテスト実施

**調査結果**:
| 競馬場 | 最適期間（複勝） | 最高複勝的中率 |
|--------|-----------------|---------------|
| 大井 | 30ヶ月 | 59.0% |
| 川崎 | 12ヶ月 | 48.3% |

**発見**:
- 競馬場ごとに最適な学習期間が異なる
- 大井: データ多いほど良い傾向
- 川崎: 12〜18ヶ月がベスト（古すぎると逆効果）

**ドキュメント**: `docs/MODEL_EVALUATION_REPORT.md` に詳細レポート

### 修正: 評価スクリプトの日付計算バグ
**問題**: 12ヶ月以上のモデルが「データ不足」でスキップされる
**原因**: レース開催日数（290日）で計算していたため、12ヶ月=360日を超過
**変更内容**:
- `evaluate_model.py` の `backtest()` 関数を修正
- 実際のカレンダー日付（datetime）で期間を計算するよう変更

### 機能追加: モデル評価スクリプト（バックテスト）
**変更内容**:
- `evaluate_model.py` を新規作成
- 異なる学習期間（6ヶ月/12ヶ月/18ヶ月/24ヶ月/30ヶ月/36ヶ月）のモデルを客観的に比較

**使い方**:
```bash
python evaluate_model.py 大井
```

**評価指標**:
| 指標 | 説明 |
|------|------|
| 単勝的中率 | 予測1位が1着になった割合 |
| 複勝的中率 | 予測1位が3着以内に入った割合 |
| AUC | 3着以内予測の精度（0.5=ランダム、1.0=完璧） |

**出力例**:
```
┌─────────┬──────────┬──────────┬──────────┐
│ 学習期間 │ 単勝的中 │ 複勝的中 │   AUC    │
├─────────┼──────────┼──────────┼──────────┤
│   6ヶ月 │  10.5% │  42.3%  │   0.621 │
│  12ヶ月 │  12.1% │  45.6% ★│   0.634 │
│  24ヶ月 │  11.8% │  44.2%  │   0.628 │
└─────────┴──────────┴──────────┴──────────┘
```

**目的**: 学習データ期間の最適値を客観的に決定するため

### 機能追加: 分析ダッシュボードAPI（SSE対応）
**変更内容**:
- `api/main.py` に誤答分析APIを追加
- SSE（Server-Sent Events）で進捗をリアルタイム送信

**追加エンドポイント**:
| エンドポイント | 機能 |
|----------------|------|
| `GET /api/analyze/{date}` | 分析実行（SSEストリーム） |
| `GET /api/analysis/{date}` | 保存済みレポート取得 |

**SSEイベント形式**:
- `start`: 分析開始（total件数）
- `progress`: 進捗（current/total, race_id）
- `result`: 分析結果（summary, by_track_condition等）
- `complete`: 完了

### 機能追加: 誤答分析パイプライン（精度向上用）
**変更内容**:
- 予測と結果を照合し、どこで外しているかを分析する機能を追加

**追加ファイル**:
- `api/main.py`: 予測時にログを`prediction_logs/{date}/{race_id}.json`に保存
- `analyze_results.py`: 結果照合・誤答分析スクリプト

**使い方**:
```bash
# レース終了後に実行
python analyze_results.py 2025-12-30
```

**分析項目**:
- 馬場状態別の的中率（良/稍重/重/不良）
- 天気別の的中率（晴/曇/雨など）
- 距離別の的中率（短距離/中距離/長距離）
- 予測確率帯別の的中率（高/中/低）
- 外れパターン分類（big_miss/moderate_miss/near_miss）

**出力**:
- コンソールにレポート表示
- `analysis_reports/{date}/report.json`に詳細保存

### 機能追加: 特徴量を5つ追加（精度向上目的）
**変更内容**:
- Qiita記事（https://qiita.com/umaro_ai/items/d1e0b61f90098ee7fbcb）を参考に特徴量を追加
- `train.py` と `api/main.py` の両方を修正

**追加した特徴量**:
| 特徴量 | 説明 | エンコーディング |
|--------|------|------------------|
| track_condition_encoded | 馬場状態（良/稍重/重/不良） | 0-3 |
| weather_encoded | 天気（晴/曇/小雨/雨/雪） | 0-4 |
| trainer_encoded | 調教師ID | ハッシュ % 10000 |
| horse_weight | 馬体重（kg） | 数値（欠損時450） |
| horse_weight_change | 馬体重増減 | 数値（欠損時0） |

**修正ファイル**:
- `train.py`:
  - `get_race_data()`: RaceData01から馬場状態・天気を抽出、テーブルから調教師・馬体重を抽出
  - `Processor.features`: 新特徴量5つを追加（21個→26個）
  - `Processor.process()`: エンコーディング処理を追加
- `api/main.py`:
  - 同様の修正を適用

**注意**: 新特徴量を反映するには、既存CSVを削除して`init`モードで再学習が必要

### 改善: 学習データ期間を3年に拡大
**変更内容**:
- `train.py` の `INIT_DAYS` を変更:
  - 変更前: 365日（1年分）
  - 変更後: 1095日（3年分）
- 参考: https://qiita.com/umaro_ai/items/d1e0b61f90098ee7fbcb
- **効果**: より多くのデータで学習することで精度向上が期待される

### 修正: モデルメタデータの日付形式バグ
**問題**: 期間が「2024-44-12」のように競馬場コードが混入
**原因**: `race_id[:8]`で競馬場コードも含めていた
**変更内容**:
- `train.py` の日付抽出を修正:
  - 変更前: `race_id[:8]` → `20254412`
  - 変更後: `race_id[:4] + race_id[6:10]` → `20251230`

### 改善: 妙味基準を厳格化
**変更内容**:
- `api/main.py` を更新:
  - 妙味判定(is_value)の基準を変更
  - 変更前: `expected_value > 1.5`
  - 変更後: `expected_value > 2.5`（かなり厳選）

### 修正: 結果表示で枠番→馬番に修正
**問題**: 結果の馬番が枠番を表示していた（7,8,8など）
**原因**: `get_race_result()`で`tds[1]`（枠番）を取得していた
**変更内容**:
- `api/main.py` の `get_race_result()` を修正:
  - `tds[2]`（馬番）を取得するよう変更

### 機能追加: オッズAPIに結果を追加
**変更内容**:
- `api/main.py` を更新:
  - `get_race_result()` 関数を追加（レース結果を取得）
  - `/api/odds` エンドポイントで `result` フィールドを返却
  - 終了したレースは1-3着の馬番を含む（未終了はnull）
- **効果**: フロントエンドで追加APIリクエストなしに結果表示可能

### 機能追加: モデル情報の可視化
**変更内容**:
- `train.py` を更新:
  - モデル保存時にメタデータ（学習日時、データ件数、期間、AUC）も保存
  - `models/model_xxx_meta.json` にJSON形式で出力
- `api/main.py` にモデル情報API追加:
  - `GET /api/models` - 全モデル情報
  - `GET /api/models/{track_code}` - 個別モデル情報
- `train.yml` を更新:
  - メタデータJSONもコミット対象に追加

### 機能追加: 予測精度の自動計測
**変更内容**:
- `evaluate_predictions.py` を新規作成:
  - レース結果を取得して予測と比較
  - 計測指標: 単勝的中率、複勝的中率、回収率
  - `accuracy/YYYY-MM-DD/{track_code}.json` に保存
- `api/main.py` に精度API追加:
  - `GET /api/accuracy/{date}/{track_code}` - 競馬場別精度
  - `GET /api/accuracy/{date}` - 日別サマリー
  - `GET /api/accuracy` - 過去30日の履歴
- `.github/workflows/evaluate.yml` を新規作成:
  - レース終了後に手動実行して精度評価

### 機能追加: 事前計算システム（高速化）
**変更内容**:
- `generate_predictions.py` を新規作成:
  - 全競馬場の予測を事前計算してJSONに保存
  - `predictions/YYYY-MM-DD/{track_code}.json` 形式で保存
  - オッズ以外の情報（馬名、騎手、AI予測確率、勝率、複勝率）を保存
- `api/main.py` に新エンドポイント追加:
  - `POST /api/odds` - オッズのみ取得（軽量）
  - `GET /api/predictions/{date}/{track_code}` - 事前計算済み予測取得
  - `GET /api/predictions/{date}` - 利用可能な予測一覧
- `.github/workflows/predict.yml` を新規作成:
  - 毎朝6時(JST)に全競馬場の予測を自動生成
  - 手動実行にも対応

### 改善: 妙味判定基準の厳格化
**問題**: 期待値 > 1.0 だと基準が緩すぎて多くの馬に🔥がつく
**変更内容**:
- `api/main.py` の `is_value` 判定を変更:
  - 変更前: `expected_value > 1.0`
  - 変更後: `expected_value > 1.5`（狙い目基準を厳格化）
- `/api/predict` と `/api/predict/race` の両エンドポイントに適用

### 改善: オッズ取得ロジック強化
**問題**: 一部の馬のオッズしか取得できない
**変更内容**:
- `api/main.py` の `get_odds()` を改善:
  - 新しいオッズページURL (`/odds/index.html`) を追加
  - CSSクラス（Odds, Umaban）による要素検出を追加
  - テキストパターンマッチングのフォールバック追加
  - 複数のテーブル形式に対応

### 修正: 勝率・複勝率の値異常 + オッズ誤取得
**問題**:
- 勝率が5000%、10000%などの異常値を表示
- オッズが斤量（54.0, 56.0）を誤取得
**原因**:
- horse_win_rateの値が不正な場合の検証なし
- 出馬表ページのパース時に斤量をオッズと誤認
**変更内容**:
- `api/main.py` の予測レスポンス生成を改善:
  - 勝率・複勝率を0-100%の範囲にクランプ
  - 値が1より大きい場合は100で割る（パーセンテージ→小数変換）
- `get_odds()` から出馬表パースを削除（誤取得の原因）

### 修正: オッズ取得ロジック改善 + 全馬データ返却
**問題**: 一部の馬のオッズが取得できない（"-"表示）
**原因**: オッズページのパースが不完全
**変更内容**:
- `predict` エンドポイントを改善:
  - 上位3頭だけでなく全馬のデータを返却
  - `field_size`（出走頭数）を追加

### 修正: GitHub Actions のpush権限エラー
**問題**: `Permission denied to github-actions[bot]` でpushが失敗
**原因**: workflowにリポジトリ書き込み権限がなかった
**変更内容**:
- `.github/workflows/train.yml` に `permissions: contents: write` を追加

## 2025-12-29
### 機能追加: 初回モデル作成 / 再学習モードの実装
**変更内容**:
- `data/` ディレクトリを新規作成（レースデータCSV保存用）
- `train.py` を大幅リファクタ:
  - `init` モード: 365日分のデータを取得してモデル作成
  - `update` モード: 差分のみ取得して再学習（効率化）
  - レースデータを `data/races_{競馬場}.csv` に保存
  - 使い方: `python train.py <競馬場名> <モード>`
- `.github/workflows/train.yml` を修正:
  - 手動実行時に「競馬場」と「モード(init/update)」を選択可能
  - スケジュール実行は毎日1競馬場ずつupdateモードで実行
  - タイムアウトを180分に延長（init用）

### リファクタ: モデル保存先をmodels/ディレクトリに整理
**変更内容**:
- `models/` ディレクトリを新規作成
- `model_v2.pkl` → `models/model_ohi.pkl` に移動・リネーム
- `train.py`: モデル保存パスを `models/` 配下に変更
- `api/main.py`: モデル読み込みパスを `models/` 配下に変更

### 機能改善: GitHub Actions を曜日ごとに分割実行
**問題**: 全14競馬場を一度に学習しようとするとタイムアウト（2時間制限）
**変更内容**:
- `.github/workflows/train.yml` を大幅修正
  - 月曜: 南関東（大井, 川崎, 船橋, 浦和）
  - 火曜: 北日本（門別, 盛岡, 水沢）
  - 水曜: 中部（金沢, 笠松, 名古屋）
  - 木曜: 西日本（園田, 姫路, 高知, 佐賀）
- 手動実行時はドロップダウンから競馬場を1つ選択可能に
- タイムアウトを120分→90分に短縮

## 2025-12-29
### 修正: オッズ取得ロジックの改善（スマホ版対応）
**問題**: 終了したレースのオッズを取得しようとすると、別のレース（現在開催中）のオッズが返されてしまう
**原因**: netkeibaのオッズページは開催中のレースのみオッズを返し、終了したレースにアクセスすると同じレース番号の当日レースのオッズが表示される
**変更内容**:
- `api/main.py` の `get_odds()` メソッドを改善:
  - 馬名リストを引数で受け取り、オッズページの馬名と照合して正しいレースか確認
  - **スマホ版結果ページ（sp.netkeiba.com）から全馬の確定オッズを取得**
    - スマホ版は結果テーブルに全馬の単勝オッズ列がある
  - 取得優先順位: 1.オッズページ → 2.スマホ版結果 → 3.PC版結果（払戻金）
  - 終了したレースでも全馬のオッズが取得可能に

### 機能追加: FastAPI バックエンド
**変更内容**:
- `api/main.py` を新規作成
  - Next.jsフロントエンドから呼び出せるREST APIを実装
  - エンドポイント:
    - `GET /api/tracks` - 競馬場一覧取得
    - `POST /api/predict` - 予測実行
  - CORS対応
  - 既存のスクレイパー・前処理ロジックを流用

- `requirements.txt` にFastAPI/uvicorn依存関係を追加
  ```
  fastapi>=0.104.0
  uvicorn>=0.24.0
  ```

### 機能追加: デプロイ設定
**変更内容**:
- `Dockerfile` を新規作成 - Docker コンテナ化
- `render.yaml` を新規作成 - Render.com デプロイ設定
