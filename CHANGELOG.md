# CHANGELOG

## 2025-12-30
### 修正: モデルメタデータの日付形式バグ
**問題**: 期間が「2024-44-12」のように競馬場コードが混入
**原因**: `race_id[:8]`で競馬場コードも含めていた
**変更内容**:
- `train.py` の日付抽出を修正:
  - 変更前: `race_id[:8]` → `20254412`
  - 変更後: `race_id[:4] + race_id[6:10]` → `20251230`

### 改善: 妙味基準を厳格化
**変更内容**:
- `api/main.py` を更新:
  - 妙味判定(is_value)の基準を変更
  - 変更前: `expected_value > 1.5`
  - 変更後: `expected_value > 2.5`（かなり厳選）

### 修正: 結果表示で枠番→馬番に修正
**問題**: 結果の馬番が枠番を表示していた（7,8,8など）
**原因**: `get_race_result()`で`tds[1]`（枠番）を取得していた
**変更内容**:
- `api/main.py` の `get_race_result()` を修正:
  - `tds[2]`（馬番）を取得するよう変更

### 機能追加: オッズAPIに結果を追加
**変更内容**:
- `api/main.py` を更新:
  - `get_race_result()` 関数を追加（レース結果を取得）
  - `/api/odds` エンドポイントで `result` フィールドを返却
  - 終了したレースは1-3着の馬番を含む（未終了はnull）
- **効果**: フロントエンドで追加APIリクエストなしに結果表示可能

### 機能追加: モデル情報の可視化
**変更内容**:
- `train.py` を更新:
  - モデル保存時にメタデータ（学習日時、データ件数、期間、AUC）も保存
  - `models/model_xxx_meta.json` にJSON形式で出力
- `api/main.py` にモデル情報API追加:
  - `GET /api/models` - 全モデル情報
  - `GET /api/models/{track_code}` - 個別モデル情報
- `train.yml` を更新:
  - メタデータJSONもコミット対象に追加

### 機能追加: 予測精度の自動計測
**変更内容**:
- `evaluate_predictions.py` を新規作成:
  - レース結果を取得して予測と比較
  - 計測指標: 単勝的中率、複勝的中率、回収率
  - `accuracy/YYYY-MM-DD/{track_code}.json` に保存
- `api/main.py` に精度API追加:
  - `GET /api/accuracy/{date}/{track_code}` - 競馬場別精度
  - `GET /api/accuracy/{date}` - 日別サマリー
  - `GET /api/accuracy` - 過去30日の履歴
- `.github/workflows/evaluate.yml` を新規作成:
  - レース終了後に手動実行して精度評価

### 機能追加: 事前計算システム（高速化）
**変更内容**:
- `generate_predictions.py` を新規作成:
  - 全競馬場の予測を事前計算してJSONに保存
  - `predictions/YYYY-MM-DD/{track_code}.json` 形式で保存
  - オッズ以外の情報（馬名、騎手、AI予測確率、勝率、複勝率）を保存
- `api/main.py` に新エンドポイント追加:
  - `POST /api/odds` - オッズのみ取得（軽量）
  - `GET /api/predictions/{date}/{track_code}` - 事前計算済み予測取得
  - `GET /api/predictions/{date}` - 利用可能な予測一覧
- `.github/workflows/predict.yml` を新規作成:
  - 毎朝6時(JST)に全競馬場の予測を自動生成
  - 手動実行にも対応

### 改善: 妙味判定基準の厳格化
**問題**: 期待値 > 1.0 だと基準が緩すぎて多くの馬に🔥がつく
**変更内容**:
- `api/main.py` の `is_value` 判定を変更:
  - 変更前: `expected_value > 1.0`
  - 変更後: `expected_value > 1.5`（狙い目基準を厳格化）
- `/api/predict` と `/api/predict/race` の両エンドポイントに適用

### 改善: オッズ取得ロジック強化
**問題**: 一部の馬のオッズしか取得できない
**変更内容**:
- `api/main.py` の `get_odds()` を改善:
  - 新しいオッズページURL (`/odds/index.html`) を追加
  - CSSクラス（Odds, Umaban）による要素検出を追加
  - テキストパターンマッチングのフォールバック追加
  - 複数のテーブル形式に対応

### 修正: 勝率・複勝率の値異常 + オッズ誤取得
**問題**:
- 勝率が5000%、10000%などの異常値を表示
- オッズが斤量（54.0, 56.0）を誤取得
**原因**:
- horse_win_rateの値が不正な場合の検証なし
- 出馬表ページのパース時に斤量をオッズと誤認
**変更内容**:
- `api/main.py` の予測レスポンス生成を改善:
  - 勝率・複勝率を0-100%の範囲にクランプ
  - 値が1より大きい場合は100で割る（パーセンテージ→小数変換）
- `get_odds()` から出馬表パースを削除（誤取得の原因）

### 修正: オッズ取得ロジック改善 + 全馬データ返却
**問題**: 一部の馬のオッズが取得できない（"-"表示）
**原因**: オッズページのパースが不完全
**変更内容**:
- `predict` エンドポイントを改善:
  - 上位3頭だけでなく全馬のデータを返却
  - `field_size`（出走頭数）を追加

### 修正: GitHub Actions のpush権限エラー
**問題**: `Permission denied to github-actions[bot]` でpushが失敗
**原因**: workflowにリポジトリ書き込み権限がなかった
**変更内容**:
- `.github/workflows/train.yml` に `permissions: contents: write` を追加

## 2025-12-29
### 機能追加: 初回モデル作成 / 再学習モードの実装
**変更内容**:
- `data/` ディレクトリを新規作成（レースデータCSV保存用）
- `train.py` を大幅リファクタ:
  - `init` モード: 365日分のデータを取得してモデル作成
  - `update` モード: 差分のみ取得して再学習（効率化）
  - レースデータを `data/races_{競馬場}.csv` に保存
  - 使い方: `python train.py <競馬場名> <モード>`
- `.github/workflows/train.yml` を修正:
  - 手動実行時に「競馬場」と「モード(init/update)」を選択可能
  - スケジュール実行は毎日1競馬場ずつupdateモードで実行
  - タイムアウトを180分に延長（init用）

### リファクタ: モデル保存先をmodels/ディレクトリに整理
**変更内容**:
- `models/` ディレクトリを新規作成
- `model_v2.pkl` → `models/model_ohi.pkl` に移動・リネーム
- `train.py`: モデル保存パスを `models/` 配下に変更
- `api/main.py`: モデル読み込みパスを `models/` 配下に変更

### 機能改善: GitHub Actions を曜日ごとに分割実行
**問題**: 全14競馬場を一度に学習しようとするとタイムアウト（2時間制限）
**変更内容**:
- `.github/workflows/train.yml` を大幅修正
  - 月曜: 南関東（大井, 川崎, 船橋, 浦和）
  - 火曜: 北日本（門別, 盛岡, 水沢）
  - 水曜: 中部（金沢, 笠松, 名古屋）
  - 木曜: 西日本（園田, 姫路, 高知, 佐賀）
- 手動実行時はドロップダウンから競馬場を1つ選択可能に
- タイムアウトを120分→90分に短縮

## 2025-12-29
### 修正: オッズ取得ロジックの改善（スマホ版対応）
**問題**: 終了したレースのオッズを取得しようとすると、別のレース（現在開催中）のオッズが返されてしまう
**原因**: netkeibaのオッズページは開催中のレースのみオッズを返し、終了したレースにアクセスすると同じレース番号の当日レースのオッズが表示される
**変更内容**:
- `api/main.py` の `get_odds()` メソッドを改善:
  - 馬名リストを引数で受け取り、オッズページの馬名と照合して正しいレースか確認
  - **スマホ版結果ページ（sp.netkeiba.com）から全馬の確定オッズを取得**
    - スマホ版は結果テーブルに全馬の単勝オッズ列がある
  - 取得優先順位: 1.オッズページ → 2.スマホ版結果 → 3.PC版結果（払戻金）
  - 終了したレースでも全馬のオッズが取得可能に

### 機能追加: FastAPI バックエンド
**変更内容**:
- `api/main.py` を新規作成
  - Next.jsフロントエンドから呼び出せるREST APIを実装
  - エンドポイント:
    - `GET /api/tracks` - 競馬場一覧取得
    - `POST /api/predict` - 予測実行
  - CORS対応
  - 既存のスクレイパー・前処理ロジックを流用

- `requirements.txt` にFastAPI/uvicorn依存関係を追加
  ```
  fastapi>=0.104.0
  uvicorn>=0.24.0
  ```

### 機能追加: デプロイ設定
**変更内容**:
- `Dockerfile` を新規作成 - Docker コンテナ化
- `render.yaml` を新規作成 - Render.com デプロイ設定
