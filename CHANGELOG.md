# CHANGELOG

## 2025-12-30
### 修正: GitHub Actions のpush権限エラー
**問題**: `Permission denied to github-actions[bot]` でpushが失敗
**原因**: workflowにリポジトリ書き込み権限がなかった
**変更内容**:
- `.github/workflows/train.yml` に `permissions: contents: write` を追加

## 2025-12-29
### 機能追加: 初回モデル作成 / 再学習モードの実装
**変更内容**:
- `data/` ディレクトリを新規作成（レースデータCSV保存用）
- `train.py` を大幅リファクタ:
  - `init` モード: 365日分のデータを取得してモデル作成
  - `update` モード: 差分のみ取得して再学習（効率化）
  - レースデータを `data/races_{競馬場}.csv` に保存
  - 使い方: `python train.py <競馬場名> <モード>`
- `.github/workflows/train.yml` を修正:
  - 手動実行時に「競馬場」と「モード(init/update)」を選択可能
  - スケジュール実行は毎日1競馬場ずつupdateモードで実行
  - タイムアウトを180分に延長（init用）

### リファクタ: モデル保存先をmodels/ディレクトリに整理
**変更内容**:
- `models/` ディレクトリを新規作成
- `model_v2.pkl` → `models/model_ohi.pkl` に移動・リネーム
- `train.py`: モデル保存パスを `models/` 配下に変更
- `api/main.py`: モデル読み込みパスを `models/` 配下に変更

### 機能改善: GitHub Actions を曜日ごとに分割実行
**問題**: 全14競馬場を一度に学習しようとするとタイムアウト（2時間制限）
**変更内容**:
- `.github/workflows/train.yml` を大幅修正
  - 月曜: 南関東（大井, 川崎, 船橋, 浦和）
  - 火曜: 北日本（門別, 盛岡, 水沢）
  - 水曜: 中部（金沢, 笠松, 名古屋）
  - 木曜: 西日本（園田, 姫路, 高知, 佐賀）
- 手動実行時はドロップダウンから競馬場を1つ選択可能に
- タイムアウトを120分→90分に短縮

## 2025-12-29
### 修正: オッズ取得ロジックの改善（スマホ版対応）
**問題**: 終了したレースのオッズを取得しようとすると、別のレース（現在開催中）のオッズが返されてしまう
**原因**: netkeibaのオッズページは開催中のレースのみオッズを返し、終了したレースにアクセスすると同じレース番号の当日レースのオッズが表示される
**変更内容**:
- `api/main.py` の `get_odds()` メソッドを改善:
  - 馬名リストを引数で受け取り、オッズページの馬名と照合して正しいレースか確認
  - **スマホ版結果ページ（sp.netkeiba.com）から全馬の確定オッズを取得**
    - スマホ版は結果テーブルに全馬の単勝オッズ列がある
  - 取得優先順位: 1.オッズページ → 2.スマホ版結果 → 3.PC版結果（払戻金）
  - 終了したレースでも全馬のオッズが取得可能に

### 機能追加: FastAPI バックエンド
**変更内容**:
- `api/main.py` を新規作成
  - Next.jsフロントエンドから呼び出せるREST APIを実装
  - エンドポイント:
    - `GET /api/tracks` - 競馬場一覧取得
    - `POST /api/predict` - 予測実行
  - CORS対応
  - 既存のスクレイパー・前処理ロジックを流用

- `requirements.txt` にFastAPI/uvicorn依存関係を追加
  ```
  fastapi>=0.104.0
  uvicorn>=0.24.0
  ```

### 機能追加: デプロイ設定
**変更内容**:
- `Dockerfile` を新規作成 - Docker コンテナ化
- `render.yaml` を新規作成 - Render.com デプロイ設定
