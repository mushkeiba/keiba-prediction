# CHANGELOG

## 2025-12-31

### 修正: アンサンブルモデルの予測エラー

**問題**: リアルタイム予測で`'dict' object has no attribute 'predict'`エラー

**原因**: train.pyでアンサンブル学習をすると、モデルがdict形式で保存される：
```python
{'lgb': lgb_model, 'xgb': xgb_model, 'type': 'ensemble'}
```
main.pyでは単一モデルとして`model.predict(X)`を呼んでいた

**変更内容**: `api/main.py` に `predict_with_model()` ヘルパー関数を追加
- アンサンブル（LightGBM + XGBoost平均）対応
- 単一モデル（LightGBMのみ）もそのまま動作

---

### 修正: リアルタイム予測時の特徴量欠損エラー

**問題**: リアルタイム予測（`/api/predict/race`）で500エラーが発生
```
KeyError: "['jockey_track_interaction', 'trainer_distance_interaction', ...] not in index"
```

**原因**:
- `main.py` の `Processor` クラスと `train.py` の `Processor` クラスが別々に実装されていた
- 学習時に使われる特徴量（交互作用、連勝数、血統など）が推論時に生成されていなかった

**変更内容**: `api/main.py` の `Processor.process()` に欠損していた特徴量生成ロジックを追加
- 交互作用特徴量: `jockey_track_interaction`, `trainer_distance_interaction`, `jockey_distance_interaction`
- 時系列特徴量: `win_streak`, `show_streak`, `recent_3_avg_rank`, `recent_10_avg_rank`, `rank_improvement`
- 血統特徴量: `father_win_rate`, `father_show_rate`, `bms_win_rate`, `bms_show_rate`

**教訓**: 学習と推論で同じ特徴量生成ロジックを使うべき

---

### 改善: スクレイピング対策を強化

**変更内容**: `api/main.py` のスクレイパーを強化

**対策内容**:
| 対策 | 詳細 |
|------|------|
| User-Agentローテーション | Chrome/Firefox/Safari/Edge の6種類をランダムに使用 |
| リアルなヘッダー | Accept, Accept-Language, Sec-Fetch-* 等を追加 |
| ランダム遅延 | 基本遅延 ± 30% + 10リクエストごとに長めの休憩 |
| リトライ機能 | 指数バックオフ（1秒→2秒→4秒）で最大3回リトライ |
| Refererヘッダー | 同一オリジンからのアクセスを模倣 |

**変更箇所**:
- `NARScraper` クラス: `_update_headers()`, `_random_delay()`, `_fetch()` を改良
- `create_scraper_session()`: スタンドアロン関数用のヘルパー追加
- `fetch_with_retry()`: リトライ機能付きフェッチ関数を追加
- `get_race_result()`, `analyze_get_race_result()`: 新ヘルパーを使用

---

### 機能追加: 層別買い目ロジック導入

**問題**:
- EVベース（期待値≥2.0）の買い目選定は、オッズの高い穴馬ばかりを選び的中率が低い
- オッズは時間経過で変動するため、朝と昼で買い目が大きく変わってしまう

**解決策**: 確率ベースの層別買い目戦略を実装

**買い目ロジック**:
| 層 | 条件 | 推奨賭け金 | 説明 |
|---|------|----------|------|
| 本命層 (honmei) | AI確率 ≥ 60% | ¥500 | オッズ関係なく高確率馬を堅実に |
| 穴馬層 (ana) | AI確率 40-60% かつ 複勝オッズ ≥ 3.0 | ¥300 | 中確率で高配当を狙う |

**変更ファイル**: `api/main.py`

**APIレスポンス変更**:
```json
// 各予測馬に追加
{
  "bet_layer": "honmei" | "ana" | null,
  "recommended_bet": 500 | 300 | 0
}

// レスポンスに追加
{
  "betting_picks": {
    "honmei": [...],  // 本命層リスト
    "ana": [...],     // 穴馬層リスト
    "total_bet": 2400 // 合計推奨賭け金
  }
}
```

**メリット**:
- 確率ベースなのでオッズ変動に左右されない安定した買い目
- 本命層は高的中率、穴馬層は高配当の二段構え
- 回収率と的中率のバランスを考慮

---

### 修正: データ品質問題の完全解決

**問題**: データ監査で重大な品質問題を発見
- `track_condition`: 100%「良」（壊れたデータ）
- `weather`: 100%「晴」（壊れたデータ）

**原因**:
- NAR netkeiba.comのスクレイピング時に`RaceData01` divが取得できずデフォルト値が入った
- 会社ネットワークのCloudflare Access/Zeroがアクセスをブロックしていた

**解決**:
Cloudflareを無効化し、全3,409レースの本物のデータを再取得

**取得結果**:
- 成功レース: 2,355/3,409 (69%)
- track_condition更新: 28,791レコード
- weather更新: 41,395レコード

**本物の分布**:
```
track_condition: 良 71% / 重 22% / 稍重 6% / 不良 1%
weather:         晴 61% / 曇 32% / 雨 7%
```

**結果**:
| バージョン | AUC | 備考 |
|-----------|-----|------|
| 壊れたデータ（100%良/晴） | 0.7761 | 不正確 |
| ランダム分布（暫定） | 0.7748 | 仮データ |
| **本物のデータ** | **0.7764** | ✅ 正確 |

**追加ツール**: `fix_track_weather.py` - 馬場状態・天気の再取得スクリプト

---

### 改善: AUC大幅向上（0.7571 → 0.7761）+2.5%
**変更内容**:
Web調査に基づき、以下のAUC向上施策を実装し、大幅な精度向上を達成:

1. **時系列特徴量（CSVから計算）** ← 最も効果的
   - `win_streak`: 連勝数（過去レースから計算）
   - `show_streak`: 複勝連続数
   - `recent_3_avg_rank`: 直近3走平均着順
   - `recent_10_avg_rank`: 直近10走平均着順
   - `rank_improvement`: 着順改善トレンド

2. **交互作用特徴量**
   - `jockey_track_interaction`: 騎手×競馬場の相性
   - `trainer_distance_interaction`: 調教師×距離の相性
   - `jockey_distance_interaction`: 騎手×距離の相性

3. **SMOTE（オーバーサンプリング）**
   - クラス不均衡対策として複勝馬をオーバーサンプリング
   - 32,679件 → 48,980件に拡張

4. **アンサンブル学習**
   - LightGBM + XGBoost のアンサンブル

**血統特徴量**: NAR馬は取得困難なため現時点ではスキップ（将来対応予定）

**追加パッケージ**:
- `imbalanced-learn`: SMOTE用
- `xgboost`: アンサンブル用

**結果**:
| モデル | AUC |
|--------|-----|
| LightGBM単体 | 0.7719 |
| XGBoost単体 | 0.7754 |
| **Ensemble** | **0.7761** |

**AUC推移**:
```
0.744  → 初期
0.7571 → 相対特徴量追加後
0.7761 → 連勝数・アンサンブル追加後（+2.5%改善）
```

---

### 改善: 相対特徴量を追加してAUC大幅向上
**変更内容**:
- 相対特徴量3つを追加（レース内での相対的な強さ）
- 着順トレンド（上り調子/下り調子）を追加
- AUC: 0.7465 → **0.7571** (+0.0106)

**追加特徴量と重要度**:
| 特徴量 | 説明 | 重要度順位 |
|--------|------|-----------|
| horse_avg_rank_vs_field | 平均着順 vs レース平均 | **1位** |
| horse_win_rate_vs_field | 勝率 vs レース平均 | 8位 |
| jockey_win_rate_vs_field | 騎手勝率 vs レース平均 | 9位 |
| rank_trend | 前走着順 - 平均着順 | - |

---

### 改善: Optuna最適化 + 不要特徴量削除
**変更内容**:
- Optunaで30回試行してハイパーパラメータを最適化
- 重要度の低い特徴量を削除（distance_category: 15.3, horse_position: 5.1）
- AUC: 0.7446 → **0.7465**

**最適化パラメータ**:
```python
num_leaves: 112, learning_rate: 0.067, min_child_samples: 65
feature_fraction: 0.78, bagging_fraction: 0.78, bagging_freq: 3
```

---

### 改善: 大井モデルを計算特徴量付きで再学習
**変更内容**:
- 騎手成績（勝率、連対率、複勝率）を全41,237件に反映
- 計算特徴量3つを学習に追加
- モデルAUC: 0.7446

**追加した計算特徴量**:
- `horse_number_ratio`: 馬番/出走頭数
- `last_rank_diff`: 前走着順 - 平均着順
- `win_rate_rank`: レース内の勝率順位

---

### 機能追加: CSV特徴量一括更新スクリプト
**変更内容**:
- `update_csv_features.py` を新規作成
- 既存CSVの騎手成績と追加特徴量を一括更新

**追加特徴量**:
| 特徴量 | 説明 |
|--------|------|
| jockey_win_rate | 騎手勝率（netkeibaから取得） |
| jockey_place_rate | 騎手連対率 |
| jockey_show_rate | 騎手複勝率 |
| horse_number_ratio | 馬番/出走頭数（内外位置） |
| distance_category | 距離区分（0=短距離, 1=中距離, 2=長距離） |
| last_rank_diff | 前走着順 - 平均着順 |
| win_rate_rank | レース内での勝率順位 |
| horse_position | 馬番位置（0=内, 1=中, 2=外） |

**使い方**:
```bash
python update_csv_features.py 大井      # 大井のみ
python update_csv_features.py --all    # 全競馬場
```

**注意**: 更新後にモデル再学習が必要

---

### 修正: 騎手成績の取得ロジックを修正
**問題**: 騎手の勝率・連対率・複勝率が全て0になっていた（特徴量重要度も0）
**原因**:
1. 正規表現が全角パーセント記号「％」に対応していなかった
2. 「複勝率」に「勝率」が含まれるため誤マッチしていた
**変更内容**:
- `train.py`, `api/main.py`: `get_jockey_stats()` を修正
  - テーブルから直接取得するように変更
  - 全角/半角パーセント記号に対応
  - 複勝率→連対率→勝率の順でチェック

**修正後の取得例**:
```
野畑凌:     勝率2.3%  連対率5.6%  複勝率9.4%
矢野貴之:   勝率7.5%  連対率15.3% 複勝率23.0%
```

**注意**: この修正を反映するには、モデルの再学習が必要です。

---

### 機能追加: 毎朝自動で予測JSONを生成
**変更内容**:
- `.github/workflows/predict.yml`: 毎朝6時(JST)に自動実行を追加
- 開催中の全競馬場を自動検出してJSON生成
- 手動実行時も競馬場を指定しなければ自動検出

**動作**:
```
毎朝6時 → 全競馬場をチェック → 開催ありならJSON生成 → Gitにコミット → デプロイ
```

---

### 修正: 予測結果の一貫性を確保（JSON優先読み込み）
**問題**: 同じ日付・同じ競馬場なのに、予測実行するたびに結果が変わる
**原因**: 毎回netkeibaから馬・騎手データをスクレイピングするため、別レースの結果で勝率等が更新されると予測結果も変わる
**変更内容**:
- `api/main.py`: `/api/predict`エンドポイントを修正
  - JSONが存在する場合 → 読み込んで返す（高速・一貫性あり）
  - JSONがない場合 → 従来通りスクレイピング＆予測
  - `from_cache: true` フラグで事前生成データ使用を識別可能
- `app.py`: Streamlit版も同様に修正
- 変更前: 毎回スクレイピング → 結果が不安定
- 変更後: 事前生成JSONを優先 → 同じ日は常に同じ結果

**使い方**:
```bash
# 1. 事前にJSONを生成
python generate_predictions.py 2025-12-31 44

# 2. Webアプリで「予測」→ JSONから読み込み（高速）
```

---

### 修正: 古い事前計算データを削除
**問題**: 12/30の予測が即表示されるが、複勝オッズが0だった
**原因**: `predictions/2025-12-30/44.json` が複勝オッズ修正前に作成されたもの
**変更内容**:
- 古い事前計算ファイルを削除
- フォールバックでリアルタイム予測（複勝オッズあり）が使用される

---

## 2025-12-30

### 修正: /api/oddsエンドポイントで複勝オッズも返す
**問題**: 事前計算パス使用時に複勝オッズが表示されなかった
**原因**: `/api/odds`が`get_odds()`（単勝のみ）を使っていた
**変更内容**:
- `api/main.py`: `/api/odds`で`get_all_odds()`を使用し、`place_odds`も返すように修正
- `keiba-web/app/page.tsx`: 事前計算パスで複勝オッズを取得・表示するように修正

---

### 修正: 複勝オッズの馬番パース修正
**問題**: 複勝オッズが一部の馬でしか取得できていなかった
**原因**: `tds[0]`（枠番）を馬番として使っていた。正しくは `tds[1]` が馬番
**変更内容**:
- `api/main.py`: `tds[0]` → `tds[1]` に修正
- テーブル構造: [枠番, 馬番, 空, 馬名, オッズ] の5列

---

### 機能追加: 複勝オッズ取得・期待値計算
**変更内容**:
- API: `get_all_odds()` で単勝・複勝オッズを一括取得
- 複勝オッズは `min-max-avg` 形式（例: 1.4-2.6倍）
- 期待値 = AI確率 × 複勝オッズ（平均）
- 期待値 > 1.0 なら黒字期待（🔥マーク）

**UI表示**:
```
カード: 複1.4-2.6倍  期待値1.23
モーダル: 全馬の複勝オッズ・期待値一覧
```

**期待値の見方**:
- 1.0以上 = 黒字期待（緑色）
- 0.8-1.0 = トントン
- 0.8未満 = 赤字傾向

---

### UI改善: フロントエンド大幅改修（keiba-web）
**変更内容**:
- 馬名がフル表示されるようにレイアウト変更
- オッズから人気順を計算して表示
- 確信度70%以上に「おすすめ」タグを表示
- 確信度による色分け（緑=高い、グレー=低い）
- モーダル詳細画面も同様に改善

**新レイアウト**:
```
上段: [AI順位] [馬番] 馬名（フル表示）     [確信度%]
下段:          騎手名  [N番人気]  オッズ   🔥 おすすめ
```

---

### 機能追加: Optunaによるハイパーパラメータ最適化
**変更内容**:
- `optimize_model.py` を新規作成
- Optunaで LightGBM のハイパーパラメータを自動最適化
- 大井モデルを最適化して本番適用

**最適化パラメータ**:
```python
{
    'num_leaves': 47,
    'learning_rate': 0.0746,
    'min_child_samples': 11,
    'reg_alpha': 0.702,
    'feature_fraction': 0.899,
    'bagging_fraction': 0.786,
    'bagging_freq': 7
}
```

**改善結果（大井競馬場）**:
| 指標 | 最適化前 | 最適化後 | 改善 |
|------|---------|---------|------|
| 単勝的中率 | 36.8% | 43.4% | +6.6pt |
| 複勝的中率 | 72.2% | 92.0% | +19.8pt |
| AUC | 0.780 | 0.919 | +0.138 |

**使い方**:
```bash
python optimize_model.py 大井
python optimize_model.py 大井 --trials 50  # 試行回数指定
```

**バックアップ**: `models/model_ohi_backup_20251230.pkl`

---

### 機能追加: 回収率計算スクリプト
**変更内容**:
- `calculate_roi.py` を新規作成
- 予測ログと実際の結果を照合して回収率を計算

**使い方**:
```bash
python calculate_roi.py 2025-12-30      # 指定日
python calculate_roi.py --all           # 全日分
```

**出力内容**:
- 単勝的中率・回収率
- 複勝的中率・回収率
- 妙味馬のみの成績
- 詳細レポート（JSON）

**出力例**:
```
【全予測】
  単勝: 5的中 / 12レース (41.7%) → 回収率 125%
  複勝: 8的中 / 12レース (66.7%) → 回収率 87%

【妙味馬のみ】
  単勝: 2的中 / 4レース (50.0%) → 回収率 180%
```

**保存先**: `roi_reports/{date}.json`

### 調査: 学習期間の最適化調査
**調査内容**:
- 学習データ期間（6ヶ月〜36ヶ月）がモデル精度に与える影響を調査
- 大井・川崎の2競馬場でバックテスト実施

**調査結果**:
| 競馬場 | 最適期間（複勝） | 最高複勝的中率 |
|--------|-----------------|---------------|
| 大井 | 30ヶ月 | 59.0% |
| 川崎 | 12ヶ月 | 48.3% |

**発見**:
- 競馬場ごとに最適な学習期間が異なる
- 大井: データ多いほど良い傾向
- 川崎: 12〜18ヶ月がベスト（古すぎると逆効果）

**ドキュメント**: `docs/MODEL_EVALUATION_REPORT.md` に詳細レポート

### 修正: 評価スクリプトの日付計算バグ
**問題**: 12ヶ月以上のモデルが「データ不足」でスキップされる
**原因**: レース開催日数（290日）で計算していたため、12ヶ月=360日を超過
**変更内容**:
- `evaluate_model.py` の `backtest()` 関数を修正
- 実際のカレンダー日付（datetime）で期間を計算するよう変更

### 機能追加: モデル評価スクリプト（バックテスト）
**変更内容**:
- `evaluate_model.py` を新規作成
- 異なる学習期間（6ヶ月/12ヶ月/18ヶ月/24ヶ月/30ヶ月/36ヶ月）のモデルを客観的に比較

**使い方**:
```bash
python evaluate_model.py 大井
```

**評価指標**:
| 指標 | 説明 |
|------|------|
| 単勝的中率 | 予測1位が1着になった割合 |
| 複勝的中率 | 予測1位が3着以内に入った割合 |
| AUC | 3着以内予測の精度（0.5=ランダム、1.0=完璧） |

**出力例**:
```
┌─────────┬──────────┬──────────┬──────────┐
│ 学習期間 │ 単勝的中 │ 複勝的中 │   AUC    │
├─────────┼──────────┼──────────┼──────────┤
│   6ヶ月 │  10.5% │  42.3%  │   0.621 │
│  12ヶ月 │  12.1% │  45.6% ★│   0.634 │
│  24ヶ月 │  11.8% │  44.2%  │   0.628 │
└─────────┴──────────┴──────────┴──────────┘
```

**目的**: 学習データ期間の最適値を客観的に決定するため

### 機能追加: 分析ダッシュボードAPI（SSE対応）
**変更内容**:
- `api/main.py` に誤答分析APIを追加
- SSE（Server-Sent Events）で進捗をリアルタイム送信

**追加エンドポイント**:
| エンドポイント | 機能 |
|----------------|------|
| `GET /api/analyze/{date}` | 分析実行（SSEストリーム） |
| `GET /api/analysis/{date}` | 保存済みレポート取得 |

**SSEイベント形式**:
- `start`: 分析開始（total件数）
- `progress`: 進捗（current/total, race_id）
- `result`: 分析結果（summary, by_track_condition等）
- `complete`: 完了

### 機能追加: 誤答分析パイプライン（精度向上用）
**変更内容**:
- 予測と結果を照合し、どこで外しているかを分析する機能を追加

**追加ファイル**:
- `api/main.py`: 予測時にログを`prediction_logs/{date}/{race_id}.json`に保存
- `analyze_results.py`: 結果照合・誤答分析スクリプト

**使い方**:
```bash
# レース終了後に実行
python analyze_results.py 2025-12-30
```

**分析項目**:
- 馬場状態別の的中率（良/稍重/重/不良）
- 天気別の的中率（晴/曇/雨など）
- 距離別の的中率（短距離/中距離/長距離）
- 予測確率帯別の的中率（高/中/低）
- 外れパターン分類（big_miss/moderate_miss/near_miss）

**出力**:
- コンソールにレポート表示
- `analysis_reports/{date}/report.json`に詳細保存

### 機能追加: 特徴量を5つ追加（精度向上目的）
**変更内容**:
- Qiita記事（https://qiita.com/umaro_ai/items/d1e0b61f90098ee7fbcb）を参考に特徴量を追加
- `train.py` と `api/main.py` の両方を修正

**追加した特徴量**:
| 特徴量 | 説明 | エンコーディング |
|--------|------|------------------|
| track_condition_encoded | 馬場状態（良/稍重/重/不良） | 0-3 |
| weather_encoded | 天気（晴/曇/小雨/雨/雪） | 0-4 |
| trainer_encoded | 調教師ID | ハッシュ % 10000 |
| horse_weight | 馬体重（kg） | 数値（欠損時450） |
| horse_weight_change | 馬体重増減 | 数値（欠損時0） |

**修正ファイル**:
- `train.py`:
  - `get_race_data()`: RaceData01から馬場状態・天気を抽出、テーブルから調教師・馬体重を抽出
  - `Processor.features`: 新特徴量5つを追加（21個→26個）
  - `Processor.process()`: エンコーディング処理を追加
- `api/main.py`:
  - 同様の修正を適用

**注意**: 新特徴量を反映するには、既存CSVを削除して`init`モードで再学習が必要

### 改善: 学習データ期間を3年に拡大
**変更内容**:
- `train.py` の `INIT_DAYS` を変更:
  - 変更前: 365日（1年分）
  - 変更後: 1095日（3年分）
- 参考: https://qiita.com/umaro_ai/items/d1e0b61f90098ee7fbcb
- **効果**: より多くのデータで学習することで精度向上が期待される

### 修正: モデルメタデータの日付形式バグ
**問題**: 期間が「2024-44-12」のように競馬場コードが混入
**原因**: `race_id[:8]`で競馬場コードも含めていた
**変更内容**:
- `train.py` の日付抽出を修正:
  - 変更前: `race_id[:8]` → `20254412`
  - 変更後: `race_id[:4] + race_id[6:10]` → `20251230`

### 改善: 妙味基準を厳格化
**変更内容**:
- `api/main.py` を更新:
  - 妙味判定(is_value)の基準を変更
  - 変更前: `expected_value > 1.5`
  - 変更後: `expected_value > 2.5`（かなり厳選）

### 修正: 結果表示で枠番→馬番に修正
**問題**: 結果の馬番が枠番を表示していた（7,8,8など）
**原因**: `get_race_result()`で`tds[1]`（枠番）を取得していた
**変更内容**:
- `api/main.py` の `get_race_result()` を修正:
  - `tds[2]`（馬番）を取得するよう変更

### 機能追加: オッズAPIに結果を追加
**変更内容**:
- `api/main.py` を更新:
  - `get_race_result()` 関数を追加（レース結果を取得）
  - `/api/odds` エンドポイントで `result` フィールドを返却
  - 終了したレースは1-3着の馬番を含む（未終了はnull）
- **効果**: フロントエンドで追加APIリクエストなしに結果表示可能

### 機能追加: モデル情報の可視化
**変更内容**:
- `train.py` を更新:
  - モデル保存時にメタデータ（学習日時、データ件数、期間、AUC）も保存
  - `models/model_xxx_meta.json` にJSON形式で出力
- `api/main.py` にモデル情報API追加:
  - `GET /api/models` - 全モデル情報
  - `GET /api/models/{track_code}` - 個別モデル情報
- `train.yml` を更新:
  - メタデータJSONもコミット対象に追加

### 機能追加: 予測精度の自動計測
**変更内容**:
- `evaluate_predictions.py` を新規作成:
  - レース結果を取得して予測と比較
  - 計測指標: 単勝的中率、複勝的中率、回収率
  - `accuracy/YYYY-MM-DD/{track_code}.json` に保存
- `api/main.py` に精度API追加:
  - `GET /api/accuracy/{date}/{track_code}` - 競馬場別精度
  - `GET /api/accuracy/{date}` - 日別サマリー
  - `GET /api/accuracy` - 過去30日の履歴
- `.github/workflows/evaluate.yml` を新規作成:
  - レース終了後に手動実行して精度評価

### 機能追加: 事前計算システム（高速化）
**変更内容**:
- `generate_predictions.py` を新規作成:
  - 全競馬場の予測を事前計算してJSONに保存
  - `predictions/YYYY-MM-DD/{track_code}.json` 形式で保存
  - オッズ以外の情報（馬名、騎手、AI予測確率、勝率、複勝率）を保存
- `api/main.py` に新エンドポイント追加:
  - `POST /api/odds` - オッズのみ取得（軽量）
  - `GET /api/predictions/{date}/{track_code}` - 事前計算済み予測取得
  - `GET /api/predictions/{date}` - 利用可能な予測一覧
- `.github/workflows/predict.yml` を新規作成:
  - 毎朝6時(JST)に全競馬場の予測を自動生成
  - 手動実行にも対応

### 改善: 妙味判定基準の厳格化
**問題**: 期待値 > 1.0 だと基準が緩すぎて多くの馬に🔥がつく
**変更内容**:
- `api/main.py` の `is_value` 判定を変更:
  - 変更前: `expected_value > 1.0`
  - 変更後: `expected_value > 1.5`（狙い目基準を厳格化）
- `/api/predict` と `/api/predict/race` の両エンドポイントに適用

### 改善: オッズ取得ロジック強化
**問題**: 一部の馬のオッズしか取得できない
**変更内容**:
- `api/main.py` の `get_odds()` を改善:
  - 新しいオッズページURL (`/odds/index.html`) を追加
  - CSSクラス（Odds, Umaban）による要素検出を追加
  - テキストパターンマッチングのフォールバック追加
  - 複数のテーブル形式に対応

### 修正: 勝率・複勝率の値異常 + オッズ誤取得
**問題**:
- 勝率が5000%、10000%などの異常値を表示
- オッズが斤量（54.0, 56.0）を誤取得
**原因**:
- horse_win_rateの値が不正な場合の検証なし
- 出馬表ページのパース時に斤量をオッズと誤認
**変更内容**:
- `api/main.py` の予測レスポンス生成を改善:
  - 勝率・複勝率を0-100%の範囲にクランプ
  - 値が1より大きい場合は100で割る（パーセンテージ→小数変換）
- `get_odds()` から出馬表パースを削除（誤取得の原因）

### 修正: オッズ取得ロジック改善 + 全馬データ返却
**問題**: 一部の馬のオッズが取得できない（"-"表示）
**原因**: オッズページのパースが不完全
**変更内容**:
- `predict` エンドポイントを改善:
  - 上位3頭だけでなく全馬のデータを返却
  - `field_size`（出走頭数）を追加

### 修正: GitHub Actions のpush権限エラー
**問題**: `Permission denied to github-actions[bot]` でpushが失敗
**原因**: workflowにリポジトリ書き込み権限がなかった
**変更内容**:
- `.github/workflows/train.yml` に `permissions: contents: write` を追加

## 2025-12-29
### 機能追加: 初回モデル作成 / 再学習モードの実装
**変更内容**:
- `data/` ディレクトリを新規作成（レースデータCSV保存用）
- `train.py` を大幅リファクタ:
  - `init` モード: 365日分のデータを取得してモデル作成
  - `update` モード: 差分のみ取得して再学習（効率化）
  - レースデータを `data/races_{競馬場}.csv` に保存
  - 使い方: `python train.py <競馬場名> <モード>`
- `.github/workflows/train.yml` を修正:
  - 手動実行時に「競馬場」と「モード(init/update)」を選択可能
  - スケジュール実行は毎日1競馬場ずつupdateモードで実行
  - タイムアウトを180分に延長（init用）

### リファクタ: モデル保存先をmodels/ディレクトリに整理
**変更内容**:
- `models/` ディレクトリを新規作成
- `model_v2.pkl` → `models/model_ohi.pkl` に移動・リネーム
- `train.py`: モデル保存パスを `models/` 配下に変更
- `api/main.py`: モデル読み込みパスを `models/` 配下に変更

### 機能改善: GitHub Actions を曜日ごとに分割実行
**問題**: 全14競馬場を一度に学習しようとするとタイムアウト（2時間制限）
**変更内容**:
- `.github/workflows/train.yml` を大幅修正
  - 月曜: 南関東（大井, 川崎, 船橋, 浦和）
  - 火曜: 北日本（門別, 盛岡, 水沢）
  - 水曜: 中部（金沢, 笠松, 名古屋）
  - 木曜: 西日本（園田, 姫路, 高知, 佐賀）
- 手動実行時はドロップダウンから競馬場を1つ選択可能に
- タイムアウトを120分→90分に短縮

## 2025-12-29
### 修正: オッズ取得ロジックの改善（スマホ版対応）
**問題**: 終了したレースのオッズを取得しようとすると、別のレース（現在開催中）のオッズが返されてしまう
**原因**: netkeibaのオッズページは開催中のレースのみオッズを返し、終了したレースにアクセスすると同じレース番号の当日レースのオッズが表示される
**変更内容**:
- `api/main.py` の `get_odds()` メソッドを改善:
  - 馬名リストを引数で受け取り、オッズページの馬名と照合して正しいレースか確認
  - **スマホ版結果ページ（sp.netkeiba.com）から全馬の確定オッズを取得**
    - スマホ版は結果テーブルに全馬の単勝オッズ列がある
  - 取得優先順位: 1.オッズページ → 2.スマホ版結果 → 3.PC版結果（払戻金）
  - 終了したレースでも全馬のオッズが取得可能に

### 機能追加: FastAPI バックエンド
**変更内容**:
- `api/main.py` を新規作成
  - Next.jsフロントエンドから呼び出せるREST APIを実装
  - エンドポイント:
    - `GET /api/tracks` - 競馬場一覧取得
    - `POST /api/predict` - 予測実行
  - CORS対応
  - 既存のスクレイパー・前処理ロジックを流用

- `requirements.txt` にFastAPI/uvicorn依存関係を追加
  ```
  fastapi>=0.104.0
  uvicorn>=0.24.0
  ```

### 機能追加: デプロイ設定
**変更内容**:
- `Dockerfile` を新規作成 - Docker コンテナ化
- `render.yaml` を新規作成 - Render.com デプロイ設定
